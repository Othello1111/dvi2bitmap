# Makefile for the test directory
#
# - The test of hello.dvi is the basic test of dvi2bitmap
# - magtest.tex is a test of whether dvi2bitmap correctly processes DVI
#   and font magnification.
# - modetest.tex is more of a test of the Metafont modes than one of
#   dvi2bitmap, but it does exercise a range of fonts, and so can show
#   some weaknesses.
#
# $Id$

CXX=@CXX@
CXXFLAGS=-I.. @CXXFLAGS@
PERLBIN=@PERL@
LIBS=@LIBS@

all: test

test: regression pathtest

regression:
	PERLBIN=$(PERLBIN) ./runtests

pathtest: ../dvi2bitmap hello.dvi
	sh ./test-font-gen.sh ../dvi2bitmap hello.dvi
	touch pathtest

magtest: ../dvi2bitmap magtest.dvi
	sh ./test-font-gen.sh ../dvi2bitmap magtest.dvi magtest-output

modetest: ../dvi2bitmap modetest.dvi
	sh ./test-font-gen.sh ../dvi2bitmap modetest.dvi modetest-output

hello.dvi: hello.tex
	tex hello

magtest.dvi: magtest.tex
	tex magtest

modetest.dvi: modetest.tex
	latex modetest


# These regression tests depend on a libdvi2bitmap.a from the source
# directory.  That directory doesn't use it, but we need it here,
# otherwise linking all the tests is too complicated to deal with happily.
# Add a suffix rule for stupid makes (hello, Tru64...)
.SUFFIXES: .o .cc
.cc.o:
	$(CXX) $(CXXFLAGS) -c $<

t1.run: t1.cc libdvi2bitmap.a
	$(CXX) $(CXXFLAGS) -o $@ t1.cc -L.. -ldvi2bitmap

# For some reason, linking t2.o against the library in the parent
# directory doesn't work, because they seem determined
# to link in std::vector, referenced from ../libdvi2bitmap.a, for
# some reason I am unable to fathom.  So link it against the full list
# of object files.  libdvi2bitmap.a is therefore a phony target, here
# to force all the parent object files to be built.
t2.run: t2.o libdvi2bitmap.a
	$(CXX) $(CXXFLAGS) -o $@ t2.o `ls ../*.o|sed '/dvi2bitmap/d'` $(LIBS)
#	$(CXX) $(CXXFLAGS) -o $@ t2.cc -L.. -ldvi2bitmap

libdvi2bitmap.a:
	cd ..; $(MAKE) libdvi2bitmap.a
	cp ../libdvi2bitmap.a .

#dvi2bitmap.diff: ../dvi2bitmap dvi2bitmap.correct
#	../dvi2bitmap -X >dvi2bitmap.test
#	diff dvi2bitmap.correct dvi2bitmap.test >dvi2bitmap.diff; \
#		if test $$? -gt 0; then echo Fail; else echo OK; fi
#
## The order of the files in the for statement below must match the
## order of the calls in dvi2bitmap::doRegression.
##
## Naw -- use the t? tests instead.
#dvi2bitmap.correct: ../dvi2bitmap
#	rm -f $@
#	for f in ../PkFont.cc ../Util.cc; do \
#		FN=`echo $$f|sed -e 's+^.*/\([^.]*\).*$$+\1+' `; \
#		sed -n "/REGRESSIONTEST/s+^.*REGRESSIONTEST:+$$FN:+p" $$f >> $@; \
#	done
