# Makefile for the test directory
#
# - The test of hello.dvi is the basic test of dvi2bitmap
# - magtest.tex is a test of whether dvi2bitmap correctly processes DVI
#   and font magnification.
# - modetest.tex is more of a test of the Metafont modes than one of
#   dvi2bitmap, but it does exercise a range of fonts, and so can show
#   some weaknesses.
#
# $Id$

# Substituted from ../configure
CXX=@CXX@
CXXFLAGS=-I.. @CXXFLAGS@
PERLBIN=@PERL@
LIBS=@LIBS@
LIBTOOL=@LIBTOOL@
LN_S=@LN_S@
# LIBTOOL substitution requires both of these
top_builddir=@top_builddir@
SHELL=@SHELL@

TESTS=t1.test t2.test t3.test t4.test t5.test t6.test t7.test t8.test

all: test

test: regression pathtest

regression: $(TESTS) t6.data
	for f in $(TESTS); do \
	    if ./$$f 2>temp.stderr; then\
		echo $$f: ok; \
	    else \
		echo $$f: FAILED; \
		mv temp.stderr $$f.stderr; \
	    fi; \
	done

# Things to do, and dependencies to satisfy, before distribution.
# Parent Makefile makes `prepare-dist' just before packaging.
prepare-dist: t5.dvi
	echo "Test directory prepared for distribution"

# Test 5 depends on its DVI file; test 7 uses it, too
t5.test t7.test: t5.dvi
# Test 6 generates its own test data
t6.data: t6.test
	./t6.test -g 500 >$@
# All the tests depend on the library
$(TESTS): ../libdvi2bitmap.la

.SUFFIXES: .o .cc .test .dvi .dtl

# Don't have separate .cc.o+.o.test implicit rules; use a single .cc.test rule
# instead.  Solaris and Alpha make don't seem to be able to handle chains of
# dependencies expressed through implicit rules.
.cc.test:
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXXFLAGS) -o $(<:.cc=.lo) $<
	$(LIBTOOL) --mode=link $(CXX) -o $@ $(<:.cc=.lo) \
		../libdvi2bitmap.la $(LIBS) -lm

.dtl.dvi:
	dt2dv $< $@ >$@.log 2>&1

# t6.test must be linked statically -- it invokes itself in a pipe
t6.test: t6.cc
	$(LIBTOOL) --mode=compile $(CXX) -static -c $(CXXFLAGS) -o \
		$(<:.cc=.lo) $<
	$(LIBTOOL) --mode=link $(CXX) -static -o $@ $(<:.cc=.lo) \
		../libdvi2bitmap.la $(LIBS) -lm

# t8.test is just a link to t8.pl.
t8.test: t8.pl
	if test -w t8.test; then rm -f t8.test;fi
	$(LN_S) t8.pl t8.test

pathtest: hello.dvi
	sh ./test-font-gen.sh ../dvi2bitmap hello.dvi temp-hello-output

magtest: magtest.dvi
	sh ./test-font-gen.sh ../dvi2bitmap magtest.dvi temp-magtest-output

modetest: modetest.dvi
	sh ./test-font-gen.sh ../dvi2bitmap modetest.dvi temp-modetest-output

hello.dvi: hello.tex
	tex hello

magtest.dvi: magtest.tex
	tex magtest

modetest.dvi: modetest.tex
	latex modetest

modetest-maths.dvi: modetest-maths.tex
	latex modetest-maths

modetest-maths-concmath.dvi: modetest-maths.tex
	ln -s modetest-maths.tex modetest-maths-concmath.tex
	latex '\def\optionswitch{1}\input modetest-maths-concmath.tex '
	rm modetest-maths-concmath.tex

%-sampler.html: %.dvi
	./make-sampler.scsh -o$(@:.html=) $<

sampler: sampler.html modetest-sampler.html modetest-maths-sampler.html modetest-maths-concmath-sampler.html
	test -d sampler || mkdir sampler
	mv modetest-sampler.html modetest-maths-sampler.html modetest-maths-concmath-sampler.html sampler
	mv modetest*.png sampler
	cp sampler.html sampler

clean:
	rm -f *~ *.o *.lo *.test *.stderr
	rm -Rf .libs
	rm -f *.log *.aux *.dvi *.pdf
	rm -f test-output* temp*
	rm -f modetest*sampler*
