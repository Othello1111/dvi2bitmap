# Makefile for the test directory
#
# - The test of hello.dvi is the basic test of dvi2bitmap
# - magtest.tex is a test of whether dvi2bitmap correctly processes DVI
#   and font magnification.
# - modetest.tex is more of a test of the Metafont modes than one of
#   dvi2bitmap, but it does exercise a range of fonts, and so can show
#   some weaknesses.
#
# $Id$

# These need to be substituted from ../configure.  I don't konw quite
# what top_builddir is, but the LIBTOOL substitution requires it
CXX=@CXX@
CXXFLAGS=-I.. @CXXFLAGS@
PERLBIN=@PERL@
LIBS=@LIBS@
top_builddir=@top_builddir@
LIBTOOL=@LIBTOOL@

TESTS=t1.test t2.test t3.test t4.test t5.test

all: test

test: regression pathtest

regression: $(TESTS)
	for f in $(TESTS); do \
	    if ./$$f 2>temp.stderr; then\
		echo $$f: ok; \
	    else \
		echo $$f: FAILED; \
		mv temp.stderr $$f.stderr; \
	    fi; \
	done

t5.test: t5.dvi

.SUFFIXES: .o .cc .test .dvi .dtl
.cc.o:
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXXFLAGS) -o $@ $<
.o.test:
	$(LIBTOOL) --mode=link $(CXX) -o $@ $< ../libdvi2bitmap.la $(LIBS) -lm
.dtl.dvi:
	dt2dv $< $@ >$@.log 2>&1

pathtest: hello.dvi
	sh ./test-font-gen.sh ../dvi2bitmap hello.dvi temp-hello-output
#	touch pathtest

magtest: magtest.dvi
	sh ./test-font-gen.sh ../dvi2bitmap magtest.dvi temp-magtest-output

modetest: modetest.dvi
	sh ./test-font-gen.sh ../dvi2bitmap modetest.dvi temp-modetest-output

hello.dvi: hello.tex
	tex hello

magtest.dvi: magtest.tex
	tex magtest

modetest.dvi: modetest.tex
	latex modetest

clean:
	rm -f *~ *.o *.lo *.test *.stderr
	rm -f *.log *.aux *.dvi *.pdf
	rm -f test-output* temp*
